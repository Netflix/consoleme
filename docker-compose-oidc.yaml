version: "3"
# Never use this in a production environment.
# Run with docker-compose -f docker-compose-saml.yaml up
services:
  consoleme:
    build: .
    ports:
      - "8081:8081"
    tty: true
    stdin_open: true
    volumes:
      - .:/apps/consoleme:delegated
      - ~/.aws:/root/.aws:cached
      - ~/.ssh:/root/.ssh:cached
    environment:
      - CONFIG_LOCATION=/apps/consoleme/example_config/example_config_oidc.yaml
      - SETUPTOOLS_USE_DISTUTILS=stdlib
    # Run commands to install Consoleme, run the service, and never exit in the event of failure (For dev debugging)
    command: >
      bash -c 'pip install argh watchdog; pip install -e /apps/consoleme/default_plugins;
      watchmedo auto-restart --recursive --pattern="*.py;*.yaml" --directory="." python consoleme/__main__.py'
    depends_on:
      - consoleme-redis
      - consoleme-dynamodb
      - consoleme_oidc
    links:
      - consoleme-redis
      - consoleme-dynamodb
      - consoleme_oidc

  consoleme_oidc:
    image: "qlik/simple-oidc-provider"
    volumes:
      - ./example_config/simple-oidc-provider:/simple-oidc-provider-settings:delegated
    container_name: consoleme_oidc
    ports:
      - "9000:9000"
    environment:
      - CONFIG_FILE=/simple-oidc-provider-settings/idp_config.json
      - USERS_FILE=/simple-oidc-provider-settings/idp_users.json
      - DEBUG=oidc-provider:*
